import os
from cw_eval.challenge_eval.off_nadir_dataset import eval_off_nadir
import cw_eval
import subprocess
import pandas as pd


class TestEvalOffNadir(object):
    """Tests for the ``eval_off_nadir`` function."""
    def test_scoring(self):
        """Test a round of scoring."""
        # load predictions
        pred_results = pd.read_csv(os.path.join(cw_eval.data.data_dir,
                                                'test_results.csv'))
        pred_results_full = pd.read_csv(os.path.join(cw_eval.data.data_dir,
                                                     'test_results_full.csv'))
        results_df, results_df_full = eval_off_nadir(
            os.path.join(cw_eval.data.data_dir, 'sample_preds.csv'),
            os.path.join(cw_eval.data.data_dir, 'sample_truth.csv')
            )
        assert pred_results.equals(results_df.reset_index())
        assert pred_results_full.equals(results_df_full)


class TestEvalCLI(object):
    """Test the CLI ``spacenet_eval`` function."""
    def test_cli(self):
        """Test a round of scoring using the CLI."""
        pred_results = pd.read_csv(os.path.join(
            cw_eval.data.data_dir, 'competition_test_results.csv'))
        pred_results_full = pd.read_csv(os.path.join(
            cw_eval.data.data_dir, 'competition_test_results_full.csv'))
        proposal_csv = os.path.join(cw_eval.data.data_dir,
                                    'sample_preds_competition.csv')
        truth_csv = os.path.join(cw_eval.data.data_dir,
                                 'sample_truth_competition.csv')
        subprocess.call(['spacenet_eval', '--proposal_csv='+proposal_csv,
                         '--truth_csv='+truth_csv,
                         '--output_file=test_out'])
        test_results = pd.read_csv('test_out.csv')
        full_test_results = pd.read_csv('test_out_full.csv')

        assert pred_results.equals(test_results)
        assert pred_results_full.sort_values(by='imageID').reset_index(drop=True).equals(
            full_test_results.sort_values(by='imageID').reset_index(drop=True))
